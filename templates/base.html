<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Torneo de Mus{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mus: {
                            50: '#fefce8',
                            100: '#fef9c3',
                            200: '#fef08a',
                            500: '#eab308',
                            600: '#ca8a04',
                            700: '#a16207',
                            800: '#854d0e',
                            900: '#713f12'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-mus-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <nav class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">
                    <a href="/" class="hover:text-mus-200">üÉè Torneo de Mus - Ribota 2025</a>
                </h1>
                
                <!-- Mobile menu button -->
                <button x-data="{ open: false }" @click="open = !open" 
                        class="md:hidden block text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    
                    <!-- Mobile menu -->
                    <div x-show="open" x-transition 
                         class="absolute top-16 left-0 w-full bg-mus-800 shadow-lg md:hidden z-50">
                        <div class="px-4 py-2 space-y-2">
                            <a href="/" class="block py-2 text-white hover:text-mus-200">Inicio</a>
                            <a href="/teams" class="block py-2 text-white hover:text-mus-200">Parejas</a>
                            <a href="/matches" class="block py-2 text-white hover:text-mus-200">Enfrentamientos</a>
                            <a href="/ranking" class="block py-2 text-white hover:text-mus-200">Ranking</a>
                        </div>
                    </div>
                </button>
                
                <!-- Desktop menu -->
                <div class="hidden md:flex space-x-6">
                    <a href="/" class="hover:text-mus-200 transition-colors">Inicio</a>
                    <a href="/teams" class="hover:text-mus-200 transition-colors">Parejas</a>
                    <a href="/matches" class="hover:text-mus-200 transition-colors">Enfrentamientos</a>
                    <a href="/ranking" class="hover:text-mus-200 transition-colors">Ranking</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main content -->
    <main class="container mx-auto px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center py-4 mt-12">
        <p class="text-sm">¬°Que gane el mejor! üèÜ ¬°Viva Ribota! üéâ</p>
    </footer>

    <!-- Admin password modal -->
    <div x-data="authModal" 
         @keydown.escape="showModal = false">
        
        <!-- Modal backdrop -->
        <div x-show="showModal" x-transition:enter="ease-out duration-300" 
             x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
             x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
             @click="showModal = false">
        </div>
        
        <!-- Modal content -->
        <div x-show="showModal" x-transition:enter="ease-out duration-300"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="ease-in duration-200"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="fixed inset-0 flex items-center justify-center p-4 z-50">
            
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6" @click.stop>
                <h3 class="text-lg font-bold text-gray-900 mb-4">üîê Acceso de Administrador</h3>
                <p class="text-gray-600 mb-4">Introduce la contrase√±a para modificar resultados:</p>
                
                <form @submit.prevent="checkPassword()">
                    <input type="password" x-model="password" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mus-500 mb-4"
                           placeholder="Contrase√±a de admin" 
                           x-ref="passwordInput">
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="closeModal()"
                                class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-mus-600 text-white rounded-md hover:bg-mus-700 transition-colors">
                            Acceder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global auth store for Alpine.js
        document.addEventListener('alpine:init', () => {
            Alpine.store('auth', {
                showModal: false,
                password: '',
                pendingAction: null,
                
                requireAuth(action) {
                    this.pendingAction = action;
                    this.showModal = true;
                    // Focus input after modal appears
                    setTimeout(() => {
                        document.querySelector('input[type="password"]')?.focus();
                    }, 100);
                },
                
                checkPassword() {
                    if (this.password === 'gallegos') {
                        this.showModal = false;
                        this.password = '';
                        if (this.pendingAction) {
                            this.pendingAction();
                            this.pendingAction = null;
                        }
                    } else {
                        alert('Contrase√±a incorrecta');
                        this.password = '';
                    }
                },
                
                closeModal() {
                    this.showModal = false;
                    this.password = '';
                    this.pendingAction = null;
                }
            });
            
            // Auth modal component
            Alpine.data('authModal', () => ({
                get showModal() { return Alpine.store('auth').showModal; },
                get password() { return Alpine.store('auth').password; },
                set password(value) { Alpine.store('auth').password = value; },
                
                checkPassword() {
                    Alpine.store('auth').checkPassword();
                },
                
                closeModal() {
                    Alpine.store('auth').closeModal();
                }
            }));
            
            // Admin auth component for form actions
            Alpine.data('adminAuth', () => ({
                requireAuth(event) {
                    event.preventDefault();
                    const form = event.target.closest('form');
                    Alpine.store('auth').requireAuth(() => {
                        form.submit();
                    });
                }
            }));
            
            // Match result form with validation
            Alpine.data('matchResultForm', () => ({
                team1Games: '',
                team2Games: '',
                errorMessage: '',
                validationMessage: '',
                isValid: false,
                isSubmitting: false,
                
                validateSelection() {
                    this.errorMessage = '';
                    
                    if (!this.team1Games || !this.team2Games) {
                        this.validationMessage = '';
                        this.isValid = false;
                        return;
                    }
                    
                    const t1 = parseInt(this.team1Games);
                    const t2 = parseInt(this.team2Games);
                    
                    // Check for tie
                    if (t1 === t2) {
                        this.validationMessage = '‚ùå No puede haber empate en una vaca';
                        this.isValid = false;
                        return;
                    }
                    
                    // Check if one team has 3 wins and the other has 0-2
                    if ((t1 === 3 && t2 >= 0 && t2 <= 2) || (t2 === 3 && t1 >= 0 && t1 <= 2)) {
                        this.validationMessage = `‚úÖ Resultado v√°lido: ${t1}-${t2}`;
                        this.isValid = true;
                    } else {
                        this.validationMessage = '‚ùå Una pareja debe ganar exactamente 3 partidas, la otra entre 0-2';
                        this.isValid = false;
                    }
                },
                
                validateAndSubmit() {
                    if (!this.isValid) {
                        this.errorMessage = 'Por favor, selecciona un resultado v√°lido';
                        return;
                    }
                    
                    this.isSubmitting = true;
                    
                    // Check authentication first, then submit normally
                    const submitForm = () => {
                        // Update form values and submit normally (browser handles redirect)
                        const form = document.querySelector('form[action*="/set-result"]');
                        form.querySelector('[name="team1_games"]').value = this.team1Games;
                        form.querySelector('[name="team2_games"]').value = this.team2Games;
                        
                        // Convert to normal form submission
                        const actualForm = document.createElement('form');
                        actualForm.method = 'POST';
                        actualForm.action = form.getAttribute('action') || form.action;
                        
                        // Add form data
                        const team1Input = document.createElement('input');
                        team1Input.type = 'hidden';
                        team1Input.name = 'team1_games';
                        team1Input.value = this.team1Games;
                        actualForm.appendChild(team1Input);
                        
                        const team2Input = document.createElement('input');
                        team2Input.type = 'hidden';
                        team2Input.name = 'team2_games';
                        team2Input.value = this.team2Games;
                        actualForm.appendChild(team2Input);
                        
                        document.body.appendChild(actualForm);
                        actualForm.submit();
                    };
                    
                    Alpine.store('auth').requireAuth(submitForm);
                }
            }));
        });
    </script>
</body>
</html>